var dashboard=dashboard||{};$(document).ready(function(){oh.initdemo()});dashboard.debug=false;dashboard.message=function(x){if(dashboard.debug&&console&&console.log){console.log(x)}};var loaddata=function(records){var snack=crossfilter(records);dashboard.snack=snack;var date=snack.dimension(function(d){return d.date?d3.time.day(d["date"]):null});var hour=snack.dimension(function(d){return d.date?d["date"].getHours()+d["date"].getMinutes()/60:null});var area=snack.dimension(function(d){return d["neighborhood"]});var who=snack.dimension(function(d){return d["prompt_id_WhoYouSnackWith"]});var cost=snack.dimension(function(d){return d["prompt_id_SnackCost"]});var period=snack.dimension(function(d){return d["prompt_id_SnackPeriod"]});var location=snack.dimension(function(d){return d["prompt_id_SnackLocation"]});var healthy=snack.dimension(function(d){return d["prompt_id_HealthyLevel"]});var day=snack.dimension(function(d){var alldays=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];return d["date"]?d["date"].getDay():null});var lat=snack.dimension(function(d){return d["latlng"]?d["latlng"][0]:null});var lng=snack.dimension(function(d){return d["latlng"]?d["latlng"][1]:null});dashboard.dim={day:day,lat:lat,lng:lng,date:date,hour:hour,area:area,who:who,cost:cost,period:period,location:location,healthy:healthy};dashboard.groups={all:snack.groupAll(),days:day.group(),lats:lat.group(),lngs:lng.group(),dates:date.group(),hours:hour.group(Math.floor),areas:area.group(),whos:who.group(),costs:cost.group(),periods:period.group(),locations:location.group(),healthys:healthy.group(Math.floor)};if(dashboard.dim.date.top(1).length<1){alert("Campaign '"+dashboard.campaign_urn+'" has no responses! Try again later (or press F5)')}initcharts();$(".leaflet-control-zoom").append($("#buttonpanel"));$("#loadinganimation").hide();$("#buttonpanel").show();$(".hoverinfo").css({left:($(window).width()-$(".hoverinfo").width())/2,right:""});$("#timeseriesbutton").trigger("click");$("#piechartbutton").trigger("click");dc.renderAll();if(oh.utils.state()[1]){var myhash=+oh.utils.state()[1];var alldata=dashboard.dim.date.top(9999);var allhashes=$.map(alldata,function(d){return d.hash});var i=$.inArray(myhash,allhashes);if(i>-1){dashboard.charts.modal.showmodal(alldata[i])}else{oh.utils.state(oh.utils.state()[0])}}};function initcharts(){dc.constants.EVENT_DELAY=5;dashboard.charts=dashboard.charts||{};var colorschema=["#8DD3C7","#BEBADA","#FB8072","#80B1D3","#FDB462","#B3DE69","#FCCDE5","#CCEBC5","#FFED6F"];var datechart=dc.barChart("#date-chart");var hourchart=dc.barChart("#hour-chart");var costchart=dc.pieChart("#cost-chart");var periodchart=dc.pieChart("#period-chart");var locationchart=dc.pieChart("#location-chart");var whochart=dc.pieChart("#who-chart");var healthychart=dc.barChart("#healthy-chart");datechart.width(830-77).height(130).transitionDuration(200).margins({top:10,right:30,bottom:20,left:30}).dimension(dashboard.dim.date).group(dashboard.groups.dates).centerBar(false).gap(1).elasticY(true).yAxisPadding(1).x(d3.time.scale().domain([new Date(2012,2,23),new Date(2012,5,8)]).rangeRound([0,10*77])).round(d3.time.day.round).xUnits(d3.time.days).renderHorizontalGridLines(true).renderVerticalGridLines(true);dashboard.renderlet=datechart.renderlet;hourchart.width(295).height(130).transitionDuration(200).margins({top:10,right:25,bottom:20,left:30}).dimension(dashboard.dim.hour).group(dashboard.groups.hours).elasticY(true).centerBar(false).gap(1).round(dc.round.floor).yAxisPadding(1).x(d3.scale.linear().domain([0,24]).rangeRound([0,10*24])).renderHorizontalGridLines(true).renderVerticalGridLines(true);costchart.width(180).height(180).radius(80).colors(colorschema).innerRadius(20).label(function(d){switch(d.data.key){case"Less than $1.00":return"< $1";case"$1.00-$3.00":return"$1-$3";case"$3.00-$5.00":return"$3-$5";case"$5.00-$7.00":return"$5-7+";case"$7.00-$10.00":return"$7-10";case"More than $10.00":return"$10+";default:return d.data.key}}).dimension(dashboard.dim.cost).group(dashboard.groups.costs);periodchart.width(180).height(180).radius(80).colors(colorschema).innerRadius(20).label(function(d){switch(d.data.key){case"Mid-morning":return"morning";case"Late night":return"night";case"Mid-afternoon":return"afternoon";case"Evening":return"evening";default:return d.data.key}}).dimension(dashboard.dim.period).group(dashboard.groups.periods);locationchart.width(180).height(180).radius(80).colors(colorschema).innerRadius(20).dimension(dashboard.dim.location).group(dashboard.groups.locations);whochart.width(180).height(180).radius(80).colors(colorschema).innerRadius(20).dimension(dashboard.dim.who).group(dashboard.groups.whos);healthychart.width(30*6+30+30+6*3).height(120).yAxisPadding(1).gap(3).margins({top:10,right:30,bottom:20,left:30}).dimension(dashboard.dim.healthy).group(dashboard.groups.healthys).round(function(n){return Math.floor(n)+.5}).elasticY(true).centerBar(true).x(d3.scale.linear().domain([0,6]).rangeRound([0,30*6])).renderHorizontalGridLines(true).xAxis().tickFormat(d3.format("d")).tickValues([1,2,3,4,5]);dc.dataCount("#data-count").dimension(dashboard.snack).group(dashboard.groups.all);$("#data-count").show();$("#map").filtermap();dashboard.charts.modal=$("#responsemodal").responsemodal();dashboard.charts.photopanel=$("#photopanel").photopanel();dashboard.charts.whychart=$("#why-chart").wordcloud({variable:"prompt_id_WhySnack"});dashboard.charts.whatchart=$("#what-chart").wordcloud({variable:"prompt_id_WhatSnack"});$("#histpanel").draggable({containment:"body",snap:"body",snapMode:"inner"});$(".title a.reset").on("click",function(e){e.preventDefault();var chartid=$(this).attr("data-chart");eval(chartid).filterAll();dc.redrawAll();return false});$("#buttonpanel button").on("dblclick",function(e){return false});$(".widgetbutton").on("click",function buttonclick(){var panel=$(this).attr("data-panel");this.state=!this.state;if(this.state){if(panel=="photopanel"){dashboard.charts.photopanel.showme()}if(panel=="wcpanel"){dashboard.charts.whychart.refresh();dashboard.charts.whatchart.refresh();$(".wccontainer").css({top:"",bottom:"",left:"",right:""})}$("#"+panel).css({top:"",bottom:"",left:"",right:""}).show()}else{if(panel=="piepanel"){costchart.filterAll();periodchart.filterAll();locationchart.filterAll();whochart.filterAll();dc.redrawAll()}if(panel=="bottompanel"){datechart.filterAll();hourchart.filterAll();dc.redrawAll()}if(panel=="histpanel"){healthychart.filterAll();dc.redrawAll()}$("#"+panel).hide()}});inithelp()}var oh=oh||{};oh.utils=oh.utils||{};oh.utils.getRandomSubarray=function(arr,size){var shuffled=arr.slice(0),i=arr.length,temp,index;while(i--){index=Math.floor(i*Math.random());temp=shuffled[index];shuffled[index]=shuffled[i];shuffled[i]=temp}return shuffled.slice(0,size)};oh.utils.delayexec=function(){var timer;function exec(call,delay){dashboard.message("clear "+timer);clearTimeout(timer);timer=setTimeout(call,delay);dashboard.message("added "+timer)}return exec};oh.utils.state=function(mycampaign,myresponse){if(!mycampaign){return window.location.hash.substring(1).split("/")}if(!myresponse){window.location.hash=mycampaign;return}window.location.hash=mycampaign+"/"+myresponse};oh.call=function(path,data,datafun){function processError(errors){if(errors[0].code&&errors[0].code=="0200"){oh.sendtologin();var pattern=/(is unknown)|(authentication token)|(not provided)/i;if(errors[0].text.match(pattern))return;alert(errors[0].text)}else{alert(errors[0].text)}}var data=data?data:{};data.client="dashboard";var myrequest=$.ajax({type:"POST",url:"/app"+path,data:data,dataType:"text",xhrFields:{withCredentials:true}}).done(function(rsptxt){if(!rsptxt||rsptxt==""){alert("Undefined error.");return false}var response=jQuery.parseJSON(rsptxt);if(response.result=="success"){if(datafun)datafun(response)}else if(response.result=="failure"){processError(response.errors);return false}else{alert("JSON response did not contain result attribute.")}}).error(function(){alert("Ohmage returned an undefined error.")});return myrequest};oh.login=function(user,password,cb){var req=oh.call("/user/auth_token",{user:user,password:password},function(response){if(!cb)return;cb()});return req};oh.logout=function(cb){oh.call("/user/logout",{},cb)};oh.sendtologin=function(){var next="login.html";if(location.hash){next=next+"?state="+location.hash.substring(1)}window.location=next};oh.campaign_read=function(cb){var req=oh.call("/campaign/read",{output_format:"short"},function(res){if(!cb)return;var arg=res.metadata&&res.metadata.items?res.metadata.items:null;cb(arg)});return req};oh.init=function(){if(oh.utils.state()[0]=="demo"){$("#loadinganimation").show();oh.initdemo()}else{oh.campaign_read(function(campaigns){var pattern=/snack/i;var snackcampaigns=[];campaigns.forEach(function(o){if(pattern.test(o)){snackcampaigns.push(o)}});if(snackcampaigns.length==0){alert("No valid snack campaign found :(")}else{if($.inArray(oh.utils.state()[0],snackcampaigns)>-1){dashboard.campaign_urn=oh.utils.state()[0]}else{dashboard.campaign_urn=snackcampaigns[Math.floor(Math.random()*snackcampaigns.length)];oh.utils.state(dashboard.campaign_urn)}$("#loadinganimation").show();oh.snackread(dashboard.campaign_urn)}})}};oh.initdemo=function(max){var myrequest=$.ajax({type:"GET",url:"data/demo/snack.csv"});myrequest.error(function(){alert("Failed to download demo data.")});myrequest.done(function(rsptxt){dashboard.campaign_urn="demo";oh.parsecsv(rsptxt,max)})};oh.parsecsv=function(string,max){var rows=d3.csv.parse(string);if(max){rows=oh.utils.getRandomSubarray(rows,max)}var records=[];rows.forEach(function(d,i){records.push({date:d["context:timestamp"]?new Date(d["context:timestamp"].replace(" ","T")):null,prompt_id_WhoYouSnackWith:d["WhoYouSnackWith:label"],prompt_id_SnackCost:d["SnackCost:label"],prompt_id_SnackPeriod:d["SnackPeriod:label"],prompt_id_SnackLocation:d["SnackLocation:label"],prompt_id_HealthyLevel:d["HealthyLevel"],latlng:d["context:location:latitude"]?[parseFloat(d["context:location:latitude"]),parseFloat(d["context:location:longitude"])]:null,user_id:d["user:id"],neighborhood:d["neighborhood"],prompt_id_WhatSnack:d["WhatSnack"],prompt_id_WhySnack:d["WhySnack"],prompt_id_SnackImage:d["SnackImage"],hash:murmurhash3_32_gc(JSON.stringify(d))})});loaddata(records)};oh.snackread=function(campaign_arg){var myrequest=$.ajax({type:"POST",url:"/app/survey_response/read",data:{campaign_urn:campaign_arg,client:"dashboard",user_list:"urn:ohmage:special:all",prompt_id_list:"urn:ohmage:special:all",output_format:"csv",sort_oder:"timestamp",column_list:""+["urn:ohmage:context:timestamp","urn:ohmage:prompt:response","urn:ohmage:context:location:latitude","urn:ohmage:context:location:longitude"],suppress_metadata:"true"},dataType:"text",xhrFields:{withCredentials:true}});myrequest.error(function(){alert("Failed to download responses from Ohmage.")});myrequest.done(function(rsptxt){if(!rsptxt||rsptxt==""){alert("Undefined error.");return false}else{oh.parsecsv(rsptxt)}})};oh.getimageurl=function(record){if(!record["prompt_id_SnackImage"]||record["prompt_id_SnackImage"]=="SKIPPED"||record["prompt_id_SnackImage"]=="NOT_DISPLAYED"){return"images/nophoto.jpg"}if(dashboard.campaign_urn=="demo"){return"data/demo/photos/"+record["prompt_id_SnackImage"]+".jpg"}else{return"/app/image/read?client=dashboard&id="+record["prompt_id_SnackImage"]}};(function($){$.fn.filtermap=function(options){var filterdelay=oh.utils.delayexec();var redrawdelay=oh.utils.delayexec();var markerdelay=oh.utils.delayexec();var markerblocker;var filterOnHover=false;querystate={hovered:null,selected:null,reset:function(){if(this.hovered){this.hover(this.hovered)}if(this.selected){this.select(this.selected)}else{this.runFilter()}},hover:function(neighborhood){this.hovered=neighborhood.hover?neighborhood:null;if(filterOnHover){this.runFilter()}else{neighborhoods.colormap()}},select:function(neighborhood){if(this.selected){this.selected.selected=false;this.selected=null;this.hovered=null}if(neighborhood.selected){this.selected=neighborhood;this.runFilter()}else{this.runFilter()}},runFilter:function(){if(this.selected){dashboard.dim.area.filter(this.selected.feature.properties.name);dc.redrawAll()}else if(this.hovered){dashboard.dim.area.filter(this.hovered.feature.properties.name);dc.redrawAll()}else{dashboard.dim.area.filterAll();dc.redrawAll()}}};var cloudmade1=new L.TileLayer("http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/1/256/{z}/{x}/{y}.png",{attribution:false,maxZoom:18});var cloudmade2=new L.TileLayer("http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png",{attribution:false,maxZoom:18});var cloudmade3=new L.TileLayer("http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/22677/256/{z}/{x}/{y}.png",{attribution:false,maxZoom:18});var cloudmade4=new L.TileLayer("http://{s}.latimes.com.s3.amazonaws.com/quiet-la-0.2.3/{z}/{x}/{y}.png",{attribution:false,maxZoom:18,subdomains:["tiles1","tiles2","tiles3","tiles4"]});var mymap=new L.Map(this.attr("id"),{center:[34.0522222,-118.2427778],zoom:9,layers:cloudmade3});mymap.on("dragstart",function(){if(!querystate.hovered)return;var s=mymap.getCenter();var handler=function(){var delta=s.distanceTo(mymap.getCenter());var total=mymap.getBounds().getSouthWest().distanceTo(mymap.getBounds().getNorthEast());var drag=Math.abs(delta/total)*100;if(drag<.5){querystate.hovered.selected=!querystate.hovered.selected;querystate.select(querystate.hovered)}this.removeEventListener("dragend",handler)};this.on("dragend",handler)});var LAData=function(jsondata){var allhoods={};var datalayer=new L.GeoJSON(jsondata,{style:function(feature){return{color:"#999",weight:1.5,opacity:.5,fillColor:"#F0F0FF",fillOpacity:.8}},onEachFeature:function(feature,layer){var neighborhood={feature:feature,layer:layer,count:0,selected:false,hover:false};allhoods[feature.properties.name]=neighborhood;layer.on("click",function(e){neighborhood.selected=!neighborhood.selected;querystate.select(neighborhood)});layer.on("mouseover",function(e){info.update(feature.properties);neighborhood.hover=true;querystate.hover(neighborhood)});layer.on("mouseout",function(e){info.update();neighborhood.hover=false;querystate.hover(neighborhood)})}});var colormap=function(){dashboard.message("updating neighborhood colors");updateCounters();for(name in allhoods){if(allhoods[name].selected){allhoods[name].layer.setStyle({color:"#999",fillOpacity:1,fillColor:"#00477F"})}else if(allhoods[name].hover){allhoods[name].layer.setStyle({color:"#999",fillOpacity:1,fillColor:"steelblue"})}else if(allhoods[name].count>0){allhoods[name].layer.setStyle({color:"#999",fillOpacity:1,fillColor:"#CCCCCC"})}else{allhoods[name].layer.setStyle({color:"#999",fillOpacity:.8,fillColor:"#F0F0FF"})}}};var updateCounters=function(){for(name in allhoods){allhoods[name].count=0}var areacounts=dashboard.groups.areas.all();for(var i=0;i<areacounts.length;i++){var name=areacounts[i].key;if(name=="")continue;allhoods[name].count=areacounts[i].value}};datalayer.colormap=colormap;return datalayer};var snackmarkers=new L.MarkerClusterGroup({});var renderMarkers=function(n){dashboard.message("updating markers.");snackmarkers.clearLayers();if(!mymap.hasLayer(snackmarkers))return;mymap.removeLayer(snackmarkers);var markerdata=dashboard.dim.date.top(n);for(var i=0;i<markerdata.length;i++){var a=markerdata[i];if(!a["latlng"]){continue}var marker=new L.Marker(new L.LatLng(a["latlng"][0],a["latlng"][1]),{title:"Test"});snackmarkers.addLayer(marker);marker.on("click",function(){var k=a;return function(){dashboard.charts.modal.showmodal(k)}}())}mymap.addLayer(snackmarkers)};var geofilter=function(){if(!mymap.hasLayer(snackmarkers)){dashboard.dim.lat.filter(null);dashboard.dim.lng.filter(null)}else{var bounds=mymap.getBounds();var lat=[bounds.getNorthEast()["lat"],bounds.getSouthWest()["lat"]];var lng=[bounds.getNorthEast()["lng"],bounds.getSouthWest()["lng"]];lat=lat[0]<lat[1]?lat:[lat[1],lat[0]];lng=lng[0]<lng[1]?lng:[lng[1],lng[0]];dashboard.dim.lat.filter(lat);dashboard.dim.lng.filter(lng)}};mymap.on("moveend",function(){if(mymap.hasLayer(snackmarkers)){geofilter();markerblocker=true;redrawdelay("dc.redrawAll()",200)}});neighborhoods=LAData(la_county);var interactlayers={Markers:snackmarkers,Neighbordhoods:neighborhoods,Disable:L.marker([0,0])};var cloudmaps={Standard:cloudmade1,Roads:cloudmade2,Grayish:cloudmade3,Quiet:cloudmade4,Disable:L.marker([0,0])};var mapcontrol=new L.Control.Layers(cloudmaps,{}).setPosition("bottomright");mymap.addControl(mapcontrol);var layercontrol=new L.Control.Layers(interactlayers,{}).setPosition("topright");mymap.addControl(layercontrol);var info=L.control();info.onAdd=function(map){this._div=L.DomUtil.create("div","hoverinfo");this.update();return this._div};info.update=function(props){if(props){this._div.innerHTML="<h4>Neighborhood</h4>"+"<b>"+props.name+"</b>";$(this._div).show()}else{$(this._div).hide()}};info.addTo(mymap);function domarkers(){dashboard.dim.lat.filter(null);dashboard.dim.lng.filter(null);renderMarkers(1e4);geofilter()}dashboard.renderlet(function(){if(mymap.hasLayer(neighborhoods)){neighborhoods.colormap()}if(mymap.hasLayer(snackmarkers)){if(markerblocker){markerblocker=false}else{snackmarkers.clearLayers();markerdelay(domarkers,100)}}});$(".leaflet-top .leaflet-control-layers-base input").on("click",function(){geofilter();querystate.reset()});mymap.attributionControl.setPrefix(false).addAttribution('Design by <a href="http://jeroenooms.github.com">Jeroen Ooms</a>');return mymap}})(jQuery);(function($){$.fn.photopanel=function(options){var pages;var pagesize=20;var currentpage=0;var photodelay=oh.utils.delayexec();var panel=$(this).draggable({containment:"body",snap:"body",snapMode:"inner"}).addClass("well");function prevthumbs(){var pagecount=pages.length;currentpage=(pagecount+currentpage-1)%pagecount;updatepictures();return false}function nextthumbs(){var pagecount=pages.length;currentpage=(pagecount+currentpage+1)%pagecount;updatepictures();return false}function fixanchors(){currentpage==0?$("#prevthumbs").hide():$("#prevthumbs").show();currentpage==pages.length-1?$("#nextthumbs").hide():$("#nextthumbs").show()}function updatepictures(){dashboard.message("updating thumbnails.");var newlist=$("<ul>",{"class":"thumbnails"});var thispage=pages[currentpage];for(var i=0;i<thispage.length;i++){var d=thispage[i];var li=$("<li>",{"class":"span2"}).appendTo(newlist);var a=$("<a>",{"class":"thumbnail",href:"#"}).appendTo(li);var img=$("<img>",{alt:d["prompt_id_WhatSnack"],"class":"img-rounded",src:getthumburl(d)});img.appendTo(a);a.on("click",function(){var k=d;return function(){dashboard.charts.modal.showmodal(k);return false}}());img.on("error",imgerror)}function displaythumblist(){newlist.appendTo("#imagelist");$("#imagelist").fadeIn(300);fixanchors()}function imgerror(){$(this).attr("src","images/photothumb.jpg")}if(!$("#imagelist").is(":empty")){$("#imagelist").fadeOut(500,function(){$("#imagelist").empty();displaythumblist()})}else{displaythumblist()}}function updatepages(){pages=[];currentpage=0;var alldata=oh.utils.getRandomSubarray(dashboard.dim.date.top(9999));for(var i=0;i<alldata.length;i++){var x=Math.floor(i/pagesize);var y=i%pagesize;pages[x]=pages[x]||[];pages[x][y]=alldata[i]}updatepictures()}function getthumburl(record){if(record["prompt_id_SnackImage"]==""||record["prompt_id_SnackImage"]=="SKIPPED"||record["prompt_id_SnackImage"]=="NOT_DISPLAYED"){return"images/photothumb.jpg"}if(dashboard.campaign_urn=="demo"){return"data/demo/thumbs/"+record["prompt_id_SnackImage"]+".jpg"}else{return"/app/image/read?client=dashboard&size=icon&id="+record["prompt_id_SnackImage"]}}function refresh(){photodelay(function(){updatepages()},500)}$("#prevthumbs").on("click",prevthumbs);$("#nextthumbs").on("click",nextthumbs);dashboard.renderlet(function(){if(panel.is(":visible")){$("#imagelist").fadeOut(150,function(){$("#imagelist").empty()});refresh()}});panel.showme=function(){$("#imagelist").empty();refresh()};return panel}})(jQuery);(function($){$.fn.wordcloud=function(options){var target=this;var id="#"+target.attr("id");var variable=options.variable;var width=options.width||350;var height=options.height||240;var font=options.font||"Helvetica";var wcdelay=oh.utils.delayexec();function build(words){var fill=d3.scale.category20();var minval=words.slice(-1)[0]["size"];var maxval=words[0]["size"];var logscale=d3.scale.linear().range([18,30]).domain([minval,maxval]);d3.layout.cloud().size([width,height]).words(words).rotate(function(d){return~~(Math.random()*3)*45-45}).font(font).fontSize(function(d){return logscale(d.size)}).on("end",function(words){d3.select(id).append("svg").attr("width",width).attr("height",height).append("g").attr("transform","translate("+width/2+","+height/2+")").selectAll("text").data(words).enter().append("text").style("font-size",function(d){return d.size+"px"}).style("font-family",font).style("fill",function(d,i){return fill(i)}).attr("text-anchor","middle").attr("transform",function(d){return"translate("+[d.x,d.y]+")rotate("+d.rotate+")"}).text(function(d){return d.text})}).start()}function refresh(){if(!target.is(":empty")){target.fadeOut(500,function(){target.empty()})}dashboard.message("scheduled wordcloud update");wcdelay(function(){update()},1e3)}function update(){dashboard.message("updating wordcloud: "+id);target.empty();var alldata=dashboard.dim.date.top(9999);var textarray=alldata.map(function(d){return d[variable]});var wordcounts=wordmap(textarray.join(" "));var words=wordcounts.map(function(d){return{text:d.key,size:d.value}});build(words);$(target).fadeIn(500)}dashboard.renderlet(function(){if(target.is(":visible")){refresh()}});target.refresh=refresh;target.parent(".wccontainer").draggable({containment:"body",snap:"body",snapMode:"inner"});return target};wordmap=function(){var stopWords=/^(not_displayed|skipped|i|me|my|myself|we|us|our|ours|ourselves|you|your|yours|yourself|yourselves|he|him|his|himself|she|her|hers|herself|it|its|itself|they|them|their|theirs|themselves|what|which|who|whom|whose|this|that|these|those|am|is|are|was|were|be|been|being|have|has|had|having|do|does|did|doing|will|would|should|can|could|ought|i'm|you're|he's|she's|it's|we're|they're|i've|you've|we've|they've|i'd|you'd|he'd|she'd|we'd|they'd|i'll|you'll|he'll|she'll|we'll|they'll|isn't|aren't|wasn't|weren't|hasn't|haven't|hadn't|doesn't|don't|didn't|won't|wouldn't|shan't|shouldn't|can't|cannot|couldn't|mustn't|let's|that's|who's|what's|here's|there's|when's|where's|why's|how's|a|an|the|and|but|if|or|because|as|until|while|of|at|by|for|with|about|against|between|into|through|during|before|after|above|below|to|from|up|upon|down|in|out|on|off|over|under|again|further|then|once|here|there|when|where|why|how|all|any|both|each|few|more|most|other|some|such|no|nor|not|only|own|same|so|than|too|very|say|says|said|shall)$/;var punctuation=/[!"&()*+,-\.\/:;<=>?\[\\\]^`\{|\}~]+/g;var wordSeparators=/[\s\u3031-\u3035\u309b\u309c\u30a0\u30fc\uff70]+/g;var discard=/^(@|https?:)/;var maxLength=30;var maxwords=50;function entries(map){var entries=[];for(var key in map)entries.push({key:key,value:map[key]});return entries}function parser(text){var tags={};var cases={};text.split(wordSeparators).forEach(function(word){if(discard.test(word))return;word=word.replace(punctuation,"");if(stopWords.test(word.toLowerCase()))return;word=word.substr(0,maxLength);cases[word.toLowerCase()]=word;tags[word=word.toLowerCase()]=(tags[word]||0)+1});tags=entries(tags).sort(function(a,b){return b.value-a.value});tags.forEach(function(d){d.key=cases[d.key]});return tags.slice(0,maxwords)}return parser}()})(jQuery);(function($){$.fn.responsemodal=function(options){var currentd;function showmodal(d){currentd=d;$("#responsemodal .modal-header h3").text(d["prompt_id_WhatSnack"].substring(0,30));$("#tablewhat").text(d["prompt_id_WhatSnack"]);$("#tablewhy").text(d["prompt_id_WhySnack"]);$("#tablewhen").text(d["prompt_id_SnackPeriod"]);$("#tablewho").text(d["prompt_id_WhoYouSnackWith"]);$("#tablewhere").text(d["prompt_id_SnackLocation"]);$("#tablecost").text(d["prompt_id_SnackCost"]);$("#tablehealthy").text(d["prompt_id_HealthyLevel"]);$("#resphoto").attr("src",oh.getimageurl(d));$("#responsemodal").modal();oh.utils.state(dashboard.campaign_urn,d["hash"])}function showfirst(){showmodal(dashboard.dim.date.top(1)[0])}function shownext(){if(!currentd){showfirst()}else{var alldata=dashboard.dim.date.top(9999);var index=$.inArray(currentd,alldata);if(index<0||index==alldata.length-1){return showmodal(alldata[0])}showmodal(alldata[index+1])}}function showprev(){if(!currentd){showfirst()}else{var alldata=dashboard.dim.date.top(9999);var index=$.inArray(currentd,alldata);if(index<0||index==0){return showmodal(alldata[alldata.length-1])}showmodal(alldata[index-1])}}$("#previtem").on("click",function(){showprev();return false});$("#nextitem").on("click",function(){shownext();return false});$("#responsemodal").on("hide",function(){oh.utils.state(dashboard.campaign_urn)});$("img#resphoto").on("error",function(){$(this).attr("src","images/nophoto.jpg")});return{showmodal:showmodal,shownext:shownext,showprev:showprev}}})(jQuery);function inithelp(){$("#helpbutton").on("click",function(){window.open("help.html");return false})}